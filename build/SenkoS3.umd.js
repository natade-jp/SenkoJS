/*!
 * SenkoJS
 * https://github.com/natade-jp/SenkoJS
 * Copyright 2013-2019 natade
 *
 * The MIT license.
 * https://opensource.org/licenses/MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).SenkoS3=e()}(this,function(){"use strict";function m(t,e,i,n,r,s,o,a,h,m,l,u,c,p,f,d){if(0===arguments.length)this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m20=0,this.m21=0,this.m22=0,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=0;else if(9===arguments.length)this.m00=t,this.m01=e,this.m02=i,this.m03=0,this.m10=n,this.m11=r,this.m12=s,this.m13=0,this.m20=o,this.m21=a,this.m22=h,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=1;else{if(16!==arguments.length)throw"IllegalArgumentException";this.m00=t,this.m01=e,this.m02=i,this.m03=n,this.m10=r,this.m11=s,this.m12=o,this.m13=a,this.m20=h,this.m21=m,this.m22=l,this.m23=u,this.m30=c,this.m31=p,this.m32=f,this.m33=d}}var l={EPSILON:2.220446049250313e-8,clamp:function(t,e,i){return t<e?e:i<t?i:t},step:function(t,e){return e<t?1:0},mix:function(t,e,i){return t+(e-t)*i},smoothstep:function(t,e,i){return t+(e-t)*(i*i*(3-2*i))},equals:function(t,e){return Math.abs(t-e)<l.EPSILON},mod:function(t,e){return t-e*parseInt(t/e)},sign:function(t){return 0<=t?1:-1},fract:function(t){return t-Math.floor(t)},rsqrt:function(t){return Math.sqrt(1/t)},radius:function(t){return t/360*(2*Math.PI)},degrees:function(t){return t/(2*Math.PI)*360}};m.prototype.equals=function(t){return l.equals(this.m00,t.m00)&&l.equals(this.m01,t.m01)&&l.equals(this.m02,t.m02)&&l.equals(this.m03,t.m03)&&l.equals(this.m10,t.m10)&&l.equals(this.m11,t.m11)&&l.equals(this.m12,t.m12)&&l.equals(this.m13,t.m13)&&l.equals(this.m20,t.m20)&&l.equals(this.m21,t.m21)&&l.equals(this.m22,t.m22)&&l.equals(this.m23,t.m23)&&l.equals(this.m30,t.m30)&&l.equals(this.m31,t.m31)&&l.equals(this.m32,t.m32)&&l.equals(this.m33,t.m33)},m.prototype.clone=function(){return new m(this.m00,this.m01,this.m02,this.m03,this.m10,this.m11,this.m12,this.m13,this.m20,this.m21,this.m22,this.m23,this.m30,this.m31,this.m32,this.m33)},m.prototype.transposed=function(){return new m(this.m00,this.m10,this.m20,this.m30,this.m01,this.m11,this.m21,this.m31,this.m02,this.m12,this.m22,this.m32,this.m03,this.m13,this.m23,this.m33)},m.prototype.isNaN=function(){returnisNaN(this.m00)||isNaN(this.m01)||isNaN(this.m02)||isNaN(this.m03)||isNaN(this.m10)||isNaN(this.m11)||isNaN(this.m12)||isNaN(this.m13)||isNaN(this.m20)||isNaN(this.m21)||isNaN(this.m22)||isNaN(this.m23)||isNaN(this.m30)||isNaN(this.m31)||isNaN(this.m32)||isNaN(this.m33)},m.prototype.isFinite=function(){returnisFinite(this.m00)&&isFinite(this.m01)&&isFinite(this.m02)&&isFinite(this.m03)||isFinite(this.m10)&&isFinite(this.m11)&&isFinite(this.m12)&&isFinite(this.m13)||isFinite(this.m20)&&isFinite(this.m21)&&isFinite(this.m22)&&isFinite(this.m23)||isFinite(this.m30)&&isFinite(this.m31)&&isFinite(this.m32)&&isFinite(this.m33)},m.prototype.isRealNumber=function(){return!this.isNaN()&&this.isFinite()},m.prototype.mul=function(t){if(t instanceof m){var e=this,i=t,n=new m;return n.m00=e.m00*i.m00+e.m01*i.m10+e.m02*i.m20+e.m03*i.m30,n.m01=e.m00*i.m01+e.m01*i.m11+e.m02*i.m21+e.m03*i.m31,n.m02=e.m00*i.m02+e.m01*i.m12+e.m02*i.m22+e.m03*i.m32,n.m03=e.m00*i.m03+e.m01*i.m13+e.m02*i.m23+e.m03*i.m33,n.m10=e.m10*i.m00+e.m11*i.m10+e.m12*i.m20+e.m13*i.m30,n.m11=e.m10*i.m01+e.m11*i.m11+e.m12*i.m21+e.m13*i.m31,n.m12=e.m10*i.m02+e.m11*i.m12+e.m12*i.m22+e.m13*i.m32,n.m13=e.m10*i.m03+e.m11*i.m13+e.m12*i.m23+e.m13*i.m33,n.m20=e.m20*i.m00+e.m21*i.m10+e.m22*i.m20+e.m23*i.m30,n.m21=e.m20*i.m01+e.m21*i.m11+e.m22*i.m21+e.m23*i.m31,n.m22=e.m20*i.m02+e.m21*i.m12+e.m22*i.m22+e.m23*i.m32,n.m23=e.m20*i.m03+e.m21*i.m13+e.m22*i.m23+e.m23*i.m33,n.m30=e.m30*i.m00+e.m31*i.m10+e.m32*i.m20+e.m33*i.m30,n.m31=e.m30*i.m01+e.m31*i.m11+e.m32*i.m21+e.m33*i.m31,n.m32=e.m30*i.m02+e.m31*i.m12+e.m32*i.m22+e.m33*i.m32,n.m33=e.m30*i.m03+e.m31*i.m13+e.m32*i.m23+e.m33*i.m33,n}if(t instanceof U){var r=this,s=t;return new U(r.m00*s.x+r.m01*s.y+r.m02*s.z+r.m03*s.w,r.m10*s.x+r.m11*s.y+r.m12*s.z+r.m13*s.w,r.m20*s.x+r.m21*s.y+r.m22*s.z+r.m23*s.w,r.m30*s.x+r.m31*s.y+r.m32*s.z+r.m33*s.w)}throw"IllegalArgumentException"},m.prototype.det3=function(){var t,e=this;return t=e.m00*e.m11*e.m22,t+=e.m10*e.m21*e.m02,t+=e.m20*e.m01*e.m12,t-=e.m00*e.m21*e.m12,t-=e.m20*e.m11*e.m02,t-=e.m10*e.m01*e.m22},m.prototype.inverse3=function(){var t=this,e=t.det3();if(0===e)return null;var i=1/e,n=t.clone();return n.m00=(t.m11*t.m22-t.m12*t.m21)*i,n.m01=(t.m02*t.m21-t.m01*t.m22)*i,n.m02=(t.m01*t.m12-t.m02*t.m11)*i,n.m10=(t.m12*t.m20-t.m10*t.m22)*i,n.m11=(t.m00*t.m22-t.m02*t.m20)*i,n.m12=(t.m02*t.m10-t.m00*t.m12)*i,n.m20=(t.m10*t.m21-t.m11*t.m20)*i,n.m21=(t.m01*t.m20-t.m00*t.m21)*i,n.m22=(t.m00*t.m11-t.m01*t.m10)*i,n},m.prototype.det4=function(){var t,e=this;return t=e.m00*e.m11*e.m22*e.m33,t+=e.m00*e.m12*e.m23*e.m31,t+=e.m00*e.m13*e.m21*e.m32,t+=e.m01*e.m10*e.m23*e.m32,t+=e.m01*e.m12*e.m20*e.m33,t+=e.m01*e.m13*e.m22*e.m30,t+=e.m02*e.m10*e.m21*e.m33,t+=e.m02*e.m11*e.m23*e.m30,t+=e.m02*e.m13*e.m20*e.m31,t+=e.m03*e.m10*e.m22*e.m31,t+=e.m03*e.m11*e.m20*e.m32,t+=e.m03*e.m12*e.m21*e.m30,t-=e.m00*e.m11*e.m23*e.m32,t-=e.m00*e.m12*e.m21*e.m33,t-=e.m00*e.m13*e.m22*e.m31,t-=e.m01*e.m10*e.m22*e.m33,t-=e.m01*e.m12*e.m23*e.m30,t-=e.m01*e.m13*e.m20*e.m32,t-=e.m02*e.m10*e.m23*e.m31,t-=e.m02*e.m11*e.m20*e.m33,t-=e.m02*e.m13*e.m21*e.m30,t-=e.m03*e.m10*e.m21*e.m32,t-=e.m03*e.m11*e.m22*e.m30,t-=e.m03*e.m12*e.m20*e.m31},m.prototype.inverse4=function(){var t=this,e=t.det4();if(0===e)return null;var i=1/e,n=new m;return n.m00=(t.m11*t.m22*t.m33+t.m12*t.m23*t.m31+t.m13*t.m21*t.m32-t.m11*t.m23*t.m32-t.m12*t.m21*t.m33-t.m13*t.m22*t.m31)*i,n.m01=(t.m01*t.m23*t.m32+t.m02*t.m21*t.m33+t.m03*t.m22*t.m31-t.m01*t.m22*t.m33-t.m02*t.m23*t.m31-t.m03*t.m21*t.m32)*i,n.m02=(t.m01*t.m12*t.m33+t.m02*t.m13*t.m31+t.m03*t.m11*t.m32-t.m01*t.m13*t.m32-t.m02*t.m11*t.m33-t.m03*t.m12*t.m31)*i,n.m03=(t.m01*t.m13*t.m22+t.m02*t.m11*t.m23+t.m03*t.m12*t.m21-t.m01*t.m12*t.m23-t.m02*t.m13*t.m21-t.m03*t.m11*t.m22)*i,n.m10=(t.m10*t.m23*t.m32+t.m12*t.m20*t.m33+t.m13*t.m22*t.m30-t.m10*t.m22*t.m33-t.m12*t.m23*t.m30-t.m13*t.m20*t.m32)*i,n.m11=(t.m00*t.m22*t.m33+t.m02*t.m23*t.m30+t.m03*t.m20*t.m32-t.m00*t.m23*t.m32-t.m02*t.m20*t.m33-t.m03*t.m22*t.m30)*i,n.m12=(t.m00*t.m13*t.m32+t.m02*t.m10*t.m33+t.m03*t.m12*t.m30-t.m00*t.m12*t.m33-t.m02*t.m13*t.m30-t.m03*t.m10*t.m32)*i,n.m13=(t.m00*t.m12*t.m23+t.m02*t.m13*t.m20+t.m03*t.m10*t.m22-t.m00*t.m13*t.m22-t.m02*t.m10*t.m23-t.m03*t.m12*t.m20)*i,n.m20=(t.m10*t.m21*t.m33+t.m11*t.m23*t.m30+t.m13*t.m20*t.m31-t.m10*t.m23*t.m31-t.m11*t.m20*t.m33-t.m13*t.m21*t.m30)*i,n.m21=(t.m00*t.m23*t.m31+t.m01*t.m20*t.m33+t.m03*t.m21*t.m30-t.m00*t.m21*t.m33-t.m01*t.m23*t.m30-t.m03*t.m20*t.m31)*i,n.m22=(t.m00*t.m11*t.m33+t.m01*t.m13*t.m30+t.m03*t.m10*t.m31-t.m00*t.m13*t.m31-t.m01*t.m10*t.m33-t.m03*t.m11*t.m30)*i,n.m23=(t.m00*t.m13*t.m21+t.m01*t.m10*t.m23+t.m03*t.m11*t.m20-t.m00*t.m11*t.m23-t.m01*t.m13*t.m20-t.m03*t.m10*t.m21)*i,n.m30=(t.m10*t.m22*t.m31+t.m11*t.m20*t.m32+t.m12*t.m21*t.m30-t.m10*t.m21*t.m32-t.m11*t.m22*t.m30-t.m12*t.m20*t.m31)*i,n.m31=(t.m00*t.m21*t.m32+t.m01*t.m22*t.m30+t.m02*t.m20*t.m31-t.m00*t.m22*t.m31-t.m01*t.m20*t.m32-t.m02*t.m21*t.m30)*i,n.m32=(t.m00*t.m12*t.m31+t.m01*t.m10*t.m32+t.m02*t.m11*t.m30-t.m00*t.m11*t.m32-t.m01*t.m12*t.m30-t.m02*t.m10*t.m31)*i,n.m33=(t.m00*t.m11*t.m22+t.m01*t.m12*t.m20+t.m02*t.m10*t.m21-t.m00*t.m12*t.m21-t.m01*t.m10*t.m22-t.m02*t.m11*t.m20)*i,n},m.prototype.toString=function(){return"[["+this.m00+" "+this.m01+" "+this.m02+" "+this.m03+"]\n ["+this.m10+" "+this.m11+" "+this.m12+" "+this.m13+"]\n ["+this.m20+" "+this.m21+" "+this.m22+" "+this.m23+"]\n ["+this.m30+" "+this.m31+" "+this.m32+" "+this.m33+"]]"},m.prototype.toInstanceArray=function(t,e){return new t(1===e?[this.m00]:4===e?[this.m00,this.m10,this.m01,this.m11]:9===e?[this.m00,this.m10,this.m20,this.m01,this.m11,this.m21,this.m02,this.m12,this.m22]:[this.m00,this.m10,this.m20,this.m30,this.m01,this.m11,this.m21,this.m31,this.m02,this.m12,this.m22,this.m32,this.m03,this.m13,this.m23,this.m33])};var U=function(t,e,i,n){this.x=t,this.y=e,this.z=void 0===i?0:i,this.w=void 0===n?1:n};U.prototype.clone=function(){return new U(this.x,this.y,this.z,this.w)},U.prototype.negate=function(){return new U(-this.x,-this.y,-this.z,this.w)},U.prototype.cross=function(t){return new U(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x,1)},U.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},U.prototype.add=function(t){return new U(this.x+t.x,this.y+t.y,this.z+t.z,1)},U.prototype.sub=function(t){return new U(this.x-t.x,this.y-t.y,this.z-t.z,1)},U.prototype.mul=function(t){if(t instanceof U)return new U(this.x*t.x,this.y*t.y,this.z*t.z,1);if(t instanceof m){var e=this,i=t;return new U(e.x*i.m00+e.y*i.m10+e.z*i.m20+e.w*i.m30,e.x*i.m01+e.y*i.m11+e.z*i.m21+e.w*i.m31,e.x*i.m02+e.y*i.m12+e.z*i.m22+e.w*i.m32,e.x*i.m03+e.y*i.m13+e.z*i.m23+e.w*i.m33)}if("number"==typeof t)return new U(this.x*t,this.y*t,this.z*t,1);throw"IllegalArgumentException"},U.prototype.setX=function(t){return new U(t,this.y,this.z,this.w)},U.prototype.setY=function(t){return new U(this.x,t,this.z,this.w)},U.prototype.setZ=function(t){return new U(this.x,this.y,t,this.w)},U.prototype.setW=function(t){return new U(this.x,this.y,this.z,t)},U.prototype.max=function(t){return new U(Math.max(this.x,t.x),Math.max(this.y,t.y),Math.max(this.z,t.z),Math.max(this.w,t.w))},U.prototype.min=function(t){return new U(Math.min(this.x,t.x),Math.min(this.y,t.y),Math.min(this.z,t.z),Math.min(this.w,t.w))},U.prototype.equals=function(t){return l.equals(this.x,t.x)&&l.equals(this.y,t.y)&&l.equals(this.z,t.z)&&l.equals(this.w,t.w)},U.prototype.mix=function(t,e){return new U(l.mix(this.x,t.x,e),l.mix(this.y,t.y,e),l.mix(this.z,t.z,e),l.mix(this.w,t.w,e))},U.prototype.norm=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},U.prototype.normFast=function(){return this.x*this.x+this.y*this.y+this.z*this.z},U.prototype.normalize=function(){var t=this.normFast();if(0===t)throw"divide error";return t=Math.sqrt(1/t),new U(this.x*t,this.y*t,this.z*t,1)},U.prototype.toString=function(t){return 1===t?"["+this.x+"]T":2===t?"["+this.x+","+this.y+"]T":3===t?"["+this.x+","+this.y+","+this.z+"]T":"["+this.x+","+this.y+","+this.z+","+this.w+"]T"},U.prototype.toHash=function(t){var e=321*parseFloat(this.x.toExponential(3).substring(0,5))&4294967295;return 2<=t&&(e=12345*e+1e4*parseFloat(this.y.toExponential(4).substring(0,6))&4294967295),3<=t&&(e=12345*e+1e4*parseFloat(this.z.toExponential(4).substring(0,6))&4294967295),4<=t&&(e=12345*e+1e4*parseFloat(this.w.toExponential(4).substring(0,6))&4294967295),e},U.prototype.toInstanceArray=function(t,e){return new t(1===e?[this.x]:2===e?[this.x,this.y]:3===e?[this.x,this.y,this.z]:[this.x,this.y,this.z,this.w])},U.prototype.pushed=function(t,e){1===e?t.push(this.x):2===e?(t.push(this.x),t.push(this.y)):3===e?(t.push(this.x),t.push(this.y),t.push(this.z)):(t.push(this.x),t.push(this.y),t.push(this.z),t.push(this.w))},U.prototype.getDirection=function(t){return t.sub(this)},U.prototype.getDirectionNormalized=function(t){return t.sub(this).normalize()},U.prototype.getDistance=function(t){return this.getDirection(t).norm()},U.prototype.isNaN=function(){return isNaN(this.x)||isNaN(this.y)||isNaN(this.z)||isNaN(this.w)},U.prototype.isFinite=function(){return isFinite(this.x)&&isFinite(this.y)&&isFinite(this.z)&&isFinite(this.w)},U.prototype.isRealNumber=function(){return!this.isNaN()&&this.isFinite()},U.getNormalVector=function(t,e,i,n,r,s){for(var o;;){var a=t.getDirection(e),h=t.getDirection(i);try{o=a.cross(h).normalize()}catch(t){o=new U(.3333,.3333,.3333);break}if(null===n|null===r|null===s)break;var m=n.getDirection(r),l=n.getDirection(s),u=void 0;try{u=1/m.cross(l).z;var c=new U,p=new U;return c.x=u*(l.y*a.x-m.y*h.x),c.y=u*(l.y*a.y-m.y*h.y),c.z=u*(l.y*a.z-m.y*h.z),p.x=u*(-l.x*a.x+m.x*h.x),p.y=u*(-l.x*a.y+m.x*h.y),p.z=u*(-l.x*a.z+m.x*h.z),{normal:o,tangent:c.normalize(),binormal:p.normalize()}}catch(t){break}}return{normal:o,tangent:null,binormal:null}},U.isClockwise=function(t,e,i){var n=t.getDirection(e).setZ(0),r=t.getDirection(i).setZ(0),s=n.cross(r).z;return 0===s?null:0<s},U.ZERO=new U(0,0,0);function i(t){this.sys=t,this.init()}i.prototype.dispose=function(){this.sys=null,this.fovY=0,this.eye=null,this.at=null,this.near=0,this.far=0},i.prototype.init=function(){this.fovY=45,this.eye=new U(0,0,0),this.at=new U(0,0,1),this.near=1,this.far=1e3},i.prototype.clone=function(){var t=new i(this.sys);return t.fovY=this.fovY,t.eye=this.eye,t.at=this.at,t.near=this.near,t.far=this.far,t},i.prototype.getVPSMatrix=function(t){var e=B.calcAspect(t.width,t.height);return{LookAt:this.sys.getMatrixLookAt(this.eye,this.at),aspect:e,PerspectiveFov:this.sys.getMatrixPerspectiveFov(this.fovY,e,this.near,this.far),Viewport:this.sys.getMatrixViewport(0,0,t.width,t.height)}},i.prototype.setDrawRange=function(t,e){this.near=t,this.far=e},i.prototype.setFovY=function(t){this.fovY=t},i.prototype.setEye=function(t){this.eye=t.clone()},i.prototype.setCenter=function(t){this.at=t.clone()},i.prototype.getDirection=function(){return this.eye.getDirectionNormalized(this.at)},i.prototype.getDistance=function(){return this.at.getDistance(this.eye)},i.prototype.setDistance=function(t){var e=this.at.getDirectionNormalized(this.eye);this.eye=this.at.add(e.mul(t))},i.prototype.getRotateY=function(){var t=this.at.getDirection(this.eye);return l.degrees(Math.atan2(t.x,t.z))},i.prototype.setRotateY=function(t){var e=l.radius(t),i=this.at.getDirection(this.eye).setY(0).norm(),n=Math.cos(e),r=Math.sin(e);this.eye=new U(this.at.x+i*r,this.eye.y,this.at.z+i*n)},i.prototype.addRotateY=function(t){this.setRotateY(this.getRotateY()+t)},i.prototype.getRotateX=function(){var t=this.at.getDirection(this.eye);return l.degrees(Math.atan2(t.z,t.y))},i.prototype.setRotateX=function(t){var e=l.radius(t),i=this.at.getDirection(this.eye).setX(0).norm(),n=Math.cos(e),r=Math.sin(e);this.eye=new U(this.eye.x,this.at.y+i*n,this.at.z+i*r)},i.prototype.addRotateX=function(t){this.setRotateX(this.getRotateX()+t)},i.prototype.translateAbsolute=function(t){this.eye=this.eye.add(t),this.at=this.at.add(t)},i.prototype.translateRelative=function(t){var e,i,n,r=new U(0,1,0);n=this.eye.getDirectionNormalized(this.at),this.sys.dimensionmode===B.DIMENSION_MODE.RIGHT_HAND&&(n=n.negate()),e=r.cross(n).normalize(),i=n.cross(e),e=e.mul(t.x),i=i.mul(t.y),n=n.mul(t.z),this.translateAbsolute(e.add(i).add(n))},i.prototype.toString=function(){return"camera[\neye  :"+this.eye+",\nat   :"+this.at+",\nfovY :"+this.fovY+"]"};function n(){this.init()}n.prototype.init=function(){this.mode=n.MODE.DIRECTIONAL_LIGHT,this.power=1,this.range=1e3,this.position=new U(0,0,0),this.direction=new U(0,0,-1),this.color=new U(1,1,1)},n.prototype.clone=function(t){var e=new(t=t||n);return e.mode=this.mode,e.power=this.power,e.range=this.range,e.position=this.position,e.direction=this.direction,e.color=this.color,e},n.prototype.setMode=function(t){this.mode=t},n.prototype.setPower=function(t){this.power=t},n.prototype.setRange=function(t){this.range=t},n.prototype.setPosition=function(t){this.position=t},n.prototype.setDirection=function(t){this.direction=t},n.prototype.setColor=function(t){this.color=t},n.MODE={NONE:0,AMBIENT_LIGHT:1,DIRECTIONAL_LIGHT:2,POINT_LIGHT:3};function r(t,e){this.sys=t,this.name="s3default",void 0!==e&&(this.name=e),this.color=new U(1,1,1,1),this.diffuse=.8,this.emission=new U(0,0,0),this.specular=new U(0,0,0),this.power=5,this.ambient=new U(.6,.6,.6),this.reflect=0,this.textureColor=this.sys.createTexture(),this.textureNormal=this.sys.createTexture()}r.prototype.dispose=function(){},r.prototype.setName=function(t){this.name=t},r.prototype.setColor=function(t){this.color=this.sys._toVector3(t)},r.prototype.setDiffuse=function(t){this.diffuse=this.sys._toValue(t)},r.prototype.setEmission=function(t){this.emission=this.sys._toVector3(t)},r.prototype.setSpecular=function(t){this.specular=this.sys._toVector3(t)},r.prototype.setPower=function(t){this.power=this.sys._toValue(t)},r.prototype.setAmbient=function(t){this.ambient=this.sys._toVector3(t)},r.prototype.setReflect=function(t){this.reflect=this.sys._toValue(t)},r.prototype.setTextureColor=function(t){null!==this.textureColor&&this.textureColor.dispose(),this.textureColor=this.sys.createTexture(),this.textureColor.setImage(t)},r.prototype.setTextureNormal=function(t){null!==this.textureNormal&&this.textureNormal.dispose(),this.textureNormal=this.sys.createTexture(),this.textureNormal.setImage(t)};function a(t){this.position=t}a.prototype.clone=function(t){return new(t=t||a)(this.position)};function o(t,e,i,n,r,s){this._init(t,e,i,n,r,s)}o.prototype._init=function(t,e,i,n,r,s){if(this.index=null,this.uv=null,this.materialIndex=null,!(n instanceof Array&&0<n.length))throw"IllegalArgumentException";this.index=[n[t],n[e],n[i]],void 0!==s&&s instanceof Array&&0<s.length&&s[0]instanceof U?this.uv=[s[t],s[e],s[i]]:this.uv=[null,null,null],r=0<=(r=r||0)?r:0,this.materialIndex=r},o.prototype.clone=function(t){return new(t=t||o)(0,1,2,this.index,this.materialIndex,this.uv)},o.prototype.inverseTriangle=function(t){return new(t=t||o)(2,1,0,this.index,this.materialIndex,this.uv)};function s(t){this.sys=t,this._init()}s.prototype._init=function(){this.src={},this.src.vertex=[],this.src.triangleindex=[],this.src.material=[],this.is_complete=!1},s.prototype.isComplete=function(){return this.is_complete},s.prototype.clone=function(t){var e=new(t=t||s)(this.sys);return e.addVertex(this.getVertexArray()),e.addTriangleIndex(this.getTriangleIndexArray()),e.addMaterial(this.getMaterialArray()),e},s.prototype.setComplete=function(t){this.is_complete=t},s.prototype.setInverseTriangle=function(t){this.setComplete(!1),this.is_inverse=t},s.prototype.getVertexArray=function(){return this.src.vertex},s.prototype.getTriangleIndexArray=function(){return this.src.triangleindex},s.prototype.getMaterialArray=function(){return this.src.material},s.prototype.addVertex=function(t){this.setComplete(!1);var e=this.getVertexArray();if(void 0===t);else if(t instanceof a)e[e.length]=t;else for(var i=0;i<t.length;i++)e[e.length]=t[i]},s.prototype.addTriangleIndex=function(t){this.setComplete(!1);var e=this.getTriangleIndexArray();if(void 0===t);else if(t instanceof o)e[e.length]=this.is_inverse?t.inverseTriangle():t;else for(var i=0;i<t.length;i++)e[e.length]=this.is_inverse?t[i].inverseTriangle():t[i]},s.prototype.addMaterial=function(t){this.setComplete(!1);var e=this.getMaterialArray();if(void 0===t);else if(t instanceof r)e[e.length]=t;else for(var i=0;i<t.length;i++)e[e.length]=t[i]};function h(t,e,i){this.setRotateZXY(t,e,i)}h._toPeriodicAngle=function(t){return h.PI<t?t-h.PI2*parseInt((t+h.PI)/h.PI2):t<-h.PI?t+h.PI2*parseInt((-t+h.PI)/h.PI2):t},h.prototype.clone=function(){return new h(this.roll,this.pitch,this.yaw)},h.prototype.setRotateZXY=function(t,e,i){this.roll=h._toPeriodicAngle(isNaN(t)?0:t),this.pitch=h._toPeriodicAngle(isNaN(e)?0:e),this.yaw=h._toPeriodicAngle(isNaN(i)?0:i)},h.prototype.addRotateX=function(t){return new h(this.roll,this.pitch+t,this.yaw)},h.prototype.addRotateY=function(t){return new h(this.roll,this.pitch,this.yaw+t)},h.prototype.addRotateZ=function(t){return new h(this.roll+t,this.pitch,this.yaw)},h.prototype.setRotateX=function(t){return new h(this.roll,t,this.yaw)},h.prototype.setRotateY=function(t){return new h(this.roll,this.pitch,t)},h.prototype.setRotateZ=function(t){return new h(t,this.pitch,this.yaw)},h.prototype.toString=function(){return"angles["+this.roll+","+this.pitch+","+this.yaw+"]"},h.PILOCK=(h.PIOVER2=(h.PI=180)/2)-1e-4,h.PI2=2*h.PI;function t(){this._init()}t.prototype._init=function(){this.angles=new h,this.scale=new U(1,1,1),this.position=new U(0,0,0),this.mesh=new s},t.prototype.setMesh=function(t){this.mesh=t},t.prototype.getMesh=function(){return this.mesh},t.prototype.setScale=function(t,e,i){1===arguments.length?"number"==typeof t?this.scale=new U(t,t,t):t instanceof U&&(this.scale=t):this.scale=new U(t,e,i)},t.prototype.getScale=function(){return this.scale},t.prototype.setPosition=function(t,e,i){this.position=1===arguments.length&&t instanceof U?t:new U(t,e,i)},t.prototype.getPosition=function(){return this.position},t.prototype.getAngle=function(){return this.angles},t.prototype.setAngle=function(t){this.angles=t},t.prototype.addRotateX=function(t){this.angles=this.angles.addRotateX(t)},t.prototype.addRotateY=function(t){this.angles=this.angles.addRotateY(t)},t.prototype.addRotateZ=function(t){this.angles=this.angles.addRotateZ(t)},t.prototype.setRotateX=function(t){this.angles=this.angles.setRotateX(t)},t.prototype.setRotateY=function(t){this.angles=this.angles.setRotateY(t)},t.prototype.setRotateZ=function(t){this.angles=this.angles.addRotateZ(t)};function e(){this._init()}e.prototype._init=function(){this.camera=new i,this.model=[],this.light=[]},e.prototype.empty=function(){this.model=[],this.light=[]},e.prototype.setCamera=function(t){this.camera=t.clone()},e.prototype.addModel=function(t){this.model[this.model.length]=t},e.prototype.addLight=function(t){this.light[this.light.length]=t},e.prototype.getCamera=function(){return this.camera},e.prototype.getModels=function(){return this.model},e.prototype.getLights=function(){return this.light};function u(t,e){this.sys=t,this._init(),void 0!==e&&this.setImage(e)}u.prototype._init=function(){this.url=null,this.image=null,this.is_loadimage=!1,this.is_dispose=!1},u.prototype.dispose=function(){this.is_dispose||(this.is_dispose=!0)},u.prototype.setImage=function(t){if(null!==t&&!this.is_dispose){if(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement){var e=t.width,i=t.height,n=function(t){var e=Math.log(t)/Math.log(2);return e-Math.floor(e)<1e-10?t:1<<Math.ceil(e)},r=n(e),s=n(i);if(e!==r||i!==s){var o=document.createElement("canvas");o.width=r,o.height=s,o.getContext("2d").drawImage(t,0,0,e,i,0,0,r,s),t=o}}if(t instanceof ImageData||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement)return null===this.url&&(this.url=this.sys._createID()),this.image=t,void(this.is_loadimage=!0);if("string"==typeof t||t instanceof String){this.url=t;var a=this;this.sys._download(this.url,function(t){a.setImage(t)})}else console.log("not setImage"),console.log(t)}};var B=function(){this._init()};B.prototype._init=function(){this.setSystemMode(B.SYSTEM_MODE.OPEN_GL),this.setBackgroundColor(new U(1,1,1,1))},B.prototype._createID=function(){void 0===this._CREATE_ID1&&(this._CREATE_ID1=0,this._CREATE_ID2=0,this._CREATE_ID3=0,this._CREATE_ID4=0);var t=this._CREATE_ID4.toString(16)+":"+this._CREATE_ID3.toString(16)+":"+this._CREATE_ID2.toString(16)+":"+this._CREATE_ID1.toString(16);if(this._CREATE_ID1++,4294967296===this._CREATE_ID1&&(this._CREATE_ID1=0,this._CREATE_ID2++,4294967296===this._CREATE_ID2&&(this._CREATE_ID2=0,this._CREATE_ID3++,4294967296===this._CREATE_ID3&&(this._CREATE_ID3=0,this._CREATE_ID4++,4294967296===this._CREATE_ID4))))throw this._CREATE_ID4=0,"createID";return t},B.prototype._download=function(t,e){var i=t.split("."),n=!1;if(1<i.length){var r=i[i.length-1].toLocaleString();n="gif"===r||"jpg"===r||"png"===r||"bmp"===r||"svg"===r||"jpeg"===r}if(n){var s=new Image;return s.onload=function(){e(s,"")},void(s.src=t)}var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState){if(200!==o.status)return console.log("error download ["+t+"]"),null;e(o.responseText,"")}},o.open("GET",t,!0),o.send(null)},B.prototype._toVector3=function(t){if(t instanceof U)return t;if(isNaN(t)){if(t instanceof Array)return new U(t[0],t[1],t[2]);throw"IllegalArgumentException"}return new U(t,t,t)},B.prototype._toValue=function(t){if(isNaN(t))throw"IllegalArgumentException";return t},B.prototype.setBackgroundColor=function(t){this.backgroundColor=t},B.prototype.getBackgroundColor=function(){return this.backgroundColor},B.prototype.setSystemMode=function(t){this.systemmode=t,this.systemmode===B.SYSTEM_MODE.OPEN_GL?(this.depthmode=B.DEPTH_MODE.OPEN_GL,this.dimensionmode=B.DIMENSION_MODE.RIGHT_HAND,this.vectormode=B.VECTOR_MODE.VECTOR4x1,this.frontface=B.FRONT_FACE.COUNTER_CLOCKWISE):(this.depthmode=B.DEPTH_MODE.DIRECT_X,this.dimensionmode=B.DIMENSION_MODE.LEFT_HAND,this.vectormode=B.VECTOR_MODE.VECTOR1x4,this.frontface=B.FRONT_FACE.CLOCKWISE),this.cullmode=B.CULL_MODE.BACK},B.prototype.setDepthMode=function(t){this.depthmode=t},B.prototype.setDimensionMode=function(t){this.dimensionmode=t},B.prototype.setVectorMode=function(t){this.vectormode=t},B.prototype.setFrontMode=function(t){this.frontface=t},B.prototype.setCullMode=function(t){this.cullmode=t},B.prototype.setCanvas=function(t){var e=this,n=t.getContext("2d");this.canvas=t,this.context2d={context:n,drawLine:function(t,e){n.beginPath(),n.moveTo(t.x,t.y),n.lineTo(e.x,e.y),n.stroke()},drawLinePolygon:function(t,e,i){n.beginPath(),n.moveTo(t.x,t.y),n.lineTo(e.x,e.y),n.lineTo(i.x,i.y),n.closePath(),n.stroke()},setLineWidth:function(t){n.lineWidth=t},setLineColor:function(t){n.strokeStyle=t},clear:function(){var t=e.getBackgroundColor();n.clearRect(0,0,e.canvas.width,e.canvas.height),n.fillStyle="rgba("+255*t.x+","+255*t.y+","+255*t.z+","+t.w+")",n.fillRect(0,0,e.canvas.width,e.canvas.height)}}},B.prototype.testCull=function(t,e,i){if(this.cullmode===B.CULL_MODE.NONE)return!1;if(this.cullmode===B.CULL_MODE.FRONT_AND_BACK)return!0;var n=U.isClockwise(t,e,i);return null===n||(n?this.frontface===B.FRONT_FACE.CLOCKWISE?this.cullmode===B.CULL_MODE.BACK:this.cullmode===B.CULL_MODE.FRONT:this.frontface===B.FRONT_FACE.CLOCKWISE?this.cullmode!==B.CULL_MODE.BACK:this.cullmode!==B.CULL_MODE.FRONT)},B.prototype.getMatrixViewport=function(t,e,i,n,r,s){void 0===r&&(r=0),void 0===s&&(s=1);var o=new m;return o.m00=i/2,o.m01=0,o.m02=0,o.m03=0,o.m10=0,o.m11=-n/2,o.m12=0,o.m13=0,o.m20=0,o.m21=0,o.m22=1,o.m23=1,o.m30=t+i/2,o.m31=e+n/2,o.m32=0,o.m33=1,this.depthmode===B.DEPTH_MODE.DIRECT_X?(o.m22=r-s,o.m32=r):this.depthmode===B.DEPTH_MODE.OPEN_GL&&(o.m22=(r-s)/2,o.m32=(r+s)/2),this.vectormode===B.VECTOR_MODE.VECTOR4x1?o.transposed():o},B.calcFovY=function(t){return 2*Math.atan(1/t)},B.calcAspect=function(t,e){return t/e},B.prototype.getMatrixPerspectiveFov=function(t,e,i,n){var r=l.radius(t),s=1/Math.tan(r/2),o=s/e,a=new m;a.m00=o,a.m01=0,a.m02=0,a.m03=0,a.m10=0,a.m11=s,a.m12=0,a.m13=0,a.m20=0,a.m21=0,a.m22=1,a.m23=1,a.m30=0,a.m31=0,a.m32=0,a.m33=0;var h=n-i;if(n<i)throw"Near > Far error";if(0==h)throw"divide error";return this.depthmode===B.DEPTH_MODE.DIRECT_X?(a.m22=n/h,a.m32=-n*i/h):this.depthmode===B.DEPTH_MODE.OPEN_GL&&(a.m22=(n+i)/h,a.m32=-2*n*i/h),this.dimensionmode===B.DIMENSION_MODE.RIGHT_HAND&&(a.m22=-a.m22,a.m23=-a.m23),this.vectormode===B.VECTOR_MODE.VECTOR4x1?a.transposed():a},B.prototype.getMatrixLookAt=function(t,e,i){void 0===i&&(i=new U(0,1,0));var n=t.getDirectionNormalized(e);this.dimensionmode===B.DIMENSION_MODE.RIGHT_HAND&&(n=n.negate());var r=i.cross(n).normalize(),s=n.cross(r),o=new m;return o.m00=r.x,o.m01=s.x,o.m02=n.x,o.m03=0,o.m10=r.y,o.m11=s.y,o.m12=n.y,o.m13=0,o.m20=r.z,o.m21=s.z,o.m22=n.z,o.m23=0,o.m30=-r.dot(t),o.m31=-s.dot(t),o.m32=-n.dot(t),o.m33=1,this.vectormode===B.VECTOR_MODE.VECTOR4x1?o.transposed():o},B.prototype.getMatrixIdentity=function(){var t=new m;return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m10=0,t.m11=1,t.m12=0,t.m13=0,t.m20=0,t.m21=0,t.m22=1,t.m23=0,t.m30=0,t.m31=0,t.m32=0,t.m33=1,t},B.prototype.getMatrixTranslate=function(t,e,i){var n=new m;return n.m00=1,n.m01=0,n.m02=0,n.m03=0,n.m10=0,n.m11=1,n.m12=0,n.m13=0,n.m20=0,n.m21=0,n.m22=1,n.m23=0,n.m30=t,n.m31=e,n.m32=i,n.m33=1,this.vectormode===B.VECTOR_MODE.VECTOR4x1?n.transposed():n},B.prototype.getMatrixScale=function(t,e,i){var n=new m;return n.m00=t,n.m01=0,n.m02=0,n.m03=0,n.m10=0,n.m11=e,n.m12=0,n.m13=0,n.m20=0,n.m21=0,n.m22=i,n.m23=0,n.m30=0,n.m31=0,n.m32=0,n.m33=1,this.vectormode===B.VECTOR_MODE.VECTOR4x1?n.transposed():n},B.prototype.getMatrixRotateX=function(t){var e=l.radius(t),i=Math.cos(e),n=Math.sin(e),r=new m;return r.m00=1,r.m01=0,r.m02=0,r.m03=0,r.m10=0,r.m11=i,r.m12=n,r.m13=0,r.m20=0,r.m21=-n,r.m22=i,r.m23=0,r.m30=0,r.m31=0,r.m32=0,r.m33=1,this.vectormode===B.VECTOR_MODE.VECTOR4x1?r.transposed():r},B.prototype.getMatrixRotateY=function(t){var e=l.radius(t),i=Math.cos(e),n=Math.sin(e),r=new m;return r.m00=i,r.m01=0,r.m02=-n,r.m03=0,r.m10=0,r.m11=1,r.m12=0,r.m13=0,r.m20=n,r.m21=0,r.m22=i,r.m23=0,r.m30=0,r.m31=0,r.m32=0,r.m33=1,this.vectormode===B.VECTOR_MODE.VECTOR4x1?r.transposed():r},B.prototype.getMatrixRotateZ=function(t){var e=l.radius(t),i=Math.cos(e),n=Math.sin(e),r=new m;return r.m00=i,r.m01=n,r.m02=0,r.m03=0,r.m10=-n,r.m11=i,r.m12=0,r.m13=0,r.m20=0,r.m21=0,r.m22=1,r.m23=0,r.m30=0,r.m31=0,r.m32=0,r.m33=1,this.vectormode===B.VECTOR_MODE.VECTOR4x1?r.transposed():r},B.prototype.mulMatrix=function(t,e){if(e instanceof m)return this.vectormode===B.VECTOR_MODE.VECTOR4x1?e.mul(t):t.mul(e);if(e instanceof U)return this.vectormode===B.VECTOR_MODE.VECTOR4x1?t.mul(e):e.mul(t);throw"IllegalArgumentException"},B.prototype.getMatrixRotateZXY=function(t,e,i){var n=this.getMatrixRotateZ(t),r=this.getMatrixRotateX(e),s=this.getMatrixRotateY(i);return this.mulMatrix(this.mulMatrix(n,r),s)},B.prototype.getMatrixWorldTransform=function(t){var e=this.getMatrixRotateZXY(t.angles.roll,t.angles.pitch,t.angles.yaw),i=this.getMatrixScale(t.scale.x,t.scale.y,t.scale.z),n=this.getMatrixTranslate(t.position.x,t.position.y,t.position.z);return this.mulMatrix(this.mulMatrix(i,e),n)},B.prototype.clear=function(){this.context2d.clear()},B.prototype._calcVertexTransformation=function(t,e,i){for(var n=[],r=0;r<t.length;r++){var s=t[r].position,o=(s=this.mulMatrix(e,s)).w;s=s.mul(1/o),s=this.mulMatrix(i,s),n[r]=new a(s)}return n},B.prototype.drawAxis=function(t){var e=t.getCamera().getVPSMatrix(this.canvas),i=[];i[0]=new U(0,0,0),i[1]=new U(10,0,0),i[2]=new U(0,10,0),i[3]=new U(0,0,10);for(var n=[],r=this.mulMatrix(e.LookAt,e.PerspectiveFov),s=0;s<i.length;s++){var o=i[s];o=(o=this.mulMatrix(r,o)).mul(1/o.w),o=this.mulMatrix(e.Viewport,o),n[s]=o}this.context2d.setLineWidth(3),this.context2d.setLineColor("rgb(255, 0, 0)"),this.context2d.drawLine(n[0],n[1]),this.context2d.setLineColor("rgb(0, 255, 0)"),this.context2d.drawLine(n[0],n[2]),this.context2d.setLineColor("rgb(0, 0, 255)"),this.context2d.drawLine(n[0],n[3])},B.prototype._drawPolygon=function(t,e){for(var i=0;i<e.length;i++){var n=e[i];this.testCull(t[n.index[0]].position,t[n.index[1]].position,t[n.index[2]].position)||this.context2d.drawLinePolygon(t[n.index[0]].position,t[n.index[1]].position,t[n.index[2]].position)}},B.prototype.drawScene=function(t){var e=t.getCamera().getVPSMatrix(this.canvas);this.context2d.setLineWidth(1),this.context2d.setLineColor("rgb(0, 0, 0)");for(var i=t.getModels(),n=0;n<i.length;n++){var r=i[n],s=r.getMesh();if(!1!==s.isComplete()){var o=this.getMatrixWorldTransform(r),a=this.mulMatrix(this.mulMatrix(o,e.LookAt),e.PerspectiveFov),h=this._calcVertexTransformation(s.src.vertex,a,e.Viewport);this._drawPolygon(h,s.src.triangleindex)}}},B.prototype._disposeObject=function(){},B.prototype.createVertex=function(t){return new a(t)},B.prototype.createTriangleIndex=function(t,e,i,n,r,s){return new o(t,e,i,n,r,s)},B.prototype.createTexture=function(t){return new u(this,t)},B.prototype.createScene=function(){return new e},B.prototype.createModel=function(){return new t},B.prototype.createMesh=function(){return new s(this)},B.prototype.createMaterial=function(t){return new r(this,t)},B.prototype.createLight=function(){return new n},B.prototype.createCamera=function(){return new i(this)},B.SYSTEM_MODE={OPEN_GL:0,DIRECT_X:1},B.DEPTH_MODE={OPEN_GL:0,DIRECT_X:1},B.DIMENSION_MODE={RIGHT_HAND:0,LEFT_HAND:1},B.VECTOR_MODE={VECTOR4x1:0,VECTOR1x4:1},B.FRONT_FACE={COUNTER_CLOCKWISE:0,CLOCKWISE:1},B.CULL_MODE={NONE:0,FRONT:1,BACK:2,FRONT_AND_BACK:3};function c(t,e){this._init(t,e)}c.prototype._init=function(t,e){this.sys=t,this.code=null,this.shader=null,this.sharder_type=-1,this.is_error=!1;var i=this;-1===e.indexOf("\n")?this.sys._download(e,function(t){i.code=t}):this.code=e},c.prototype.isError=function(){return this.is_error},c.prototype.getCode=function(){return this.code},c.prototype.getShader=function(){var t=this.sys.getGL();if(null===t||this.is_error||null===this.code)return null;if(null!==this.shader)return this.shader;var e=this.code,i=0;i=-1!==(e=(e=e.replace(/\/\/.*/g,"")).replace(/\/\*([^*]|\*[^/])*\*\//g,"")).indexOf("gl_FragColor")?t.FRAGMENT_SHADER:t.VERTEX_SHADER;var n=this.sys.glfunc.createShader(i,e);return n.is_error?(this.is_error=!0,null):(this.shader=n.shader,this.sharder_type=i,this.shader)},c.prototype.getShaderType=function(){return-1!==this.sharder_type?this.sharder_type:null!==this.getShader()?this.sharder_type:null},c.prototype.dispose=function(){return null===this.sys.getGL()?null:(null===this.shader||(this.sys.glfunc.deleteShader(this.shader),this.shader=null,this.sharder_type=-1),!0)};function p(t,e,i){if(t instanceof i.instance)this.data=t;else if(t instanceof U||t instanceof m)this.data=t.toInstanceArray(i.instance,e);else if(t instanceof Array)this.data=new i.instance(t);else{if(isNaN(t))throw"IllegalArgumentException";this.data=new i.instance([t])}this.dimension=e,this.datatype=i;var n="";n=t instanceof U?"S3Vector":t instanceof m?"S3Matrix":"Number",this.glsltype=p.gltypetable[i.name][n][e]}p.datatype={Float32Array:{instance:Float32Array,name:"Float32Array"},Int32Array:{instance:Int32Array,name:"Int32Array"}},p.gltypetable={Float32Array:{Number:{1:"float",2:"vec2",3:"vec3",4:"vec4"},S3Vector:{2:"vec2",3:"vec3",4:"vec4"},S3Matrix:{4:"mat2",9:"mat3",16:"mat4"}},Int32Array:{Number:{1:"int",2:"ivec2",3:"ivec3",4:"ivec4"},S3Vector:{2:"ivec2",3:"ivec3",4:"ivec4"}}};function f(t,e){this._init(t,e)}f.prototype._init=function(n,t){this.id=t,this.sys=n,this.vertex=null,this.fragment=null,this.isDLVertex=!1,this.isDLFragment=!1,this.program=null,this.is_linked=!1,this.is_error=!1,this.enable_vertex_number={};var e={attribute:{},uniform:{},modifiers:[],datatype:[]};this.variable=e;var r=this;this.activeTextureId=0;var i={uniform1iv:function(t,e){n.getGL()&&n.getGL().uniform1iv(t,e)},uniform2iv:function(t,e){n.getGL()&&n.getGL().uniform2iv(t,e)},uniform3iv:function(t,e){n.getGL()&&n.getGL().uniform3iv(t,e)},uniform4iv:function(t,e){n.getGL()&&n.getGL().uniform4iv(t,e)},uniform1fv:function(t,e){n.getGL()&&n.getGL().uniform1fv(t,e)},uniform2fv:function(t,e){n.getGL()&&n.getGL().uniform2fv(t,e)},uniform3fv:function(t,e){n.getGL()&&n.getGL().uniform3fv(t,e)},uniform4fv:function(t,e){n.getGL()&&n.getGL().uniform4fv(t,e)},uniformMatrix2fv:function(t,e){n.getGL()&&n.getGL().uniformMatrix2fv(t,!1,e)},uniformMatrix3fv:function(t,e){n.getGL()&&n.getGL().uniformMatrix3fv(t,!1,e)},uniformMatrix4fv:function(t,e){n.getGL()&&n.getGL().uniformMatrix4fv(t,!1,e)},uniformSampler2D:function(t,e){var i=n.getGL();i&&(i.activeTexture(i.TEXTURE0+r.activeTextureId),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(t,r.activeTextureId),r.activeTextureId++)}},u={int:{glsltype:"int",instance:Int32Array,size:1,btype:"INT",bind:i.uniform1iv},float:{glsltype:"float",instance:Float32Array,size:1,btype:"FLOAT",bind:i.uniform1fv},bool:{glsltype:"bool",instance:Int32Array,size:1,btype:"INT",bind:i.uniform1iv},mat2:{glsltype:"mat2",instance:Float32Array,size:4,btype:"FLOAT",bind:i.uniformMatrix2fv},mat3:{glsltype:"mat3",instance:Float32Array,size:9,btype:"FLOAT",bind:i.uniformMatrix3fv},mat4:{glsltype:"mat4",instance:Float32Array,size:16,btype:"FLOAT",bind:i.uniformMatrix4fv},vec2:{glsltype:"vec2",instance:Float32Array,size:2,btype:"FLOAT",bind:i.uniform2fv},vec3:{glsltype:"vec3",instance:Float32Array,size:3,btype:"FLOAT",bind:i.uniform3fv},vec4:{glsltype:"vec4",instance:Float32Array,size:4,btype:"FLOAT",bind:i.uniform4fv},ivec2:{glsltype:"ivec2",instance:Int32Array,size:2,btype:"INT",bind:i.uniform2iv},ivec3:{glsltype:"ivec3",instance:Int32Array,size:3,btype:"INT",bind:i.uniform3iv},ivec4:{glsltype:"ivec4",instance:Int32Array,size:4,btype:"INT",bind:i.uniform4iv},bvec2:{glsltype:"bvec2",instance:Int32Array,size:2,btype:"INT",bind:i.uniform2iv},bvec3:{glsltype:"bvec3",instance:Int32Array,size:3,btype:"INT",bind:i.uniform3iv},bvec4:{glsltype:"bvec4",instance:Int32Array,size:4,btype:"INT",bind:i.uniform4iv},sampler2D:{glsltype:"sampler2D",instance:Image,size:1,btype:"TEXTURE",bind:i.uniformSampler2D},samplerCube:{glsltype:"samplerCube",instance:Image,size:1,btype:"TEXTURE",bind:null}};this.analysisShader=function(t,e){for(var i=(t=(t=t.replace(/\/\/.*/g,"")).replace(/\/\*([^*]|\*[^/])*\*\//g,"")).split("\n"),n=0;n<i.length;n++){var r=i[n].match(/(attribute|uniform)\s+(\w+)\s+(\w+)\s*(\[\s*\w+\s*\])?;/);if(null!==r){var s=r[1],o=r[2],a=r[3],h=void 0!==r[4],m=u[o];for(var l in e[a]={},m)e[a][l]=m[l];e[a].name=a,e[a].modifiers=s,e[a].is_array=h,e[a].location=[]}}}},f.prototype.resetActiveTextureId=function(){this.activeTextureId=0},f.prototype.isLinked=function(){return this.is_linked},f.prototype.dispose=function(){return null!==this.sys.getGL()&&(this.is_linked&&(this.disuseProgram(),this.sys.glfunc.deleteProgram(this.program,this.vertex.getShader(),this.fragment.getShader()),this.program=null,this.is_linked=!1),null!==this.vertex&&(this.vertex.dispose(),this.vertex=null),null!==this.fragment&&(this.fragment.dispose(),this.fragment=null),this._init(this.sys,this.id),!0)},f.prototype.setVertexShader=function(t){return!this.isLinked()&&(null!==this.vertex&&(this.vertex.dispose(),this.vertex=null),this.vertex=new c(this.sys,t),!(this.is_error=!1))},f.prototype.setFragmentShader=function(t){return!this.isLinked()&&(null!==this.fragment&&(this.fragment.dispose(),this.fragment=null),this.fragment=new c(this.sys,t),!(this.is_error=!1))},f.prototype.useProgram=function(){if(!this.isLinked())return!1;var t=this.getProgram();return t&&this.sys.getGL()&&this.sys.getGL().useProgram(t),!0},f.prototype.disuseProgram=function(){if(!this.isLinked())return!1;var t=this.sys.getGL();if(t){for(var e in this.enable_vertex_number)t.disableVertexAttribArray(e);this.enable_vertex_number={}}return!0},f.prototype.getProgram=function(){var t=this.sys.getGL();if(null===t||this.is_error)return null;if(this.isDLVertex||this.isDLFragment)return null;if(this.isLinked())return this.program;if(null===this.vertex)return console.log("do not set VERTEX_SHADER"),this.is_error=!0,null;if(null===this.fragment)return console.log("do not set FRAGMENT_SHADER"),this.is_error=!0,null;var e=this.vertex.isError(),i=this.fragment.isError();if(e||i)return console.log("shader compile error"),this.is_error=!0,null;var n=this.vertex.getShader(),r=this.fragment.getShader();if(null===n||null===r)return null;if(this.vertex.getShaderType()!==t.VERTEX_SHADER)return console.log("VERTEX_SHADER is not VERTEX_SHADER"),this.is_error=!0,null;if(this.fragment.getShaderType()!==t.FRAGMENT_SHADER)return console.log("FRAGMENT_SHADER is not FRAGMENT_SHADER"),this.is_error=!0,null;var s=this.sys.glfunc.createProgram(n,r);return s.is_error?(this.is_error=!0,null):(this.is_linked=!0,this.program=s.program,this.analysisShader(this.vertex.getCode(),this.variable),this.analysisShader(this.fragment.getCode(),this.variable),this.program)},f.prototype.bindData=function(t,e){if(!this.isLinked())return!1;var i=this.sys.getGL(),n=this.getProgram(),r=this.variable[t];if(void 0===r)return!1;if(0===r.location.length)if("attribute"===r.modifiers)r.location[0]=i.getAttribLocation(n,t);else if(r.is_array)for(var s=0;s<e.length;s++)r.location[s]=i.getUniformLocation(n,t+"["+s+"]");else r.location[0]=i.getUniformLocation(n,t);if(-1===r.location[0])return!1;function o(t){if(t instanceof WebGLBuffer&&"attribute"===r.modifiers)return t;if(t instanceof WebGLTexture&&"sampler2D"===r.glsltype)return t;if(t instanceof r.instance)return t;if(t instanceof p&&r.glsltype===t.glsltype)return t.data;if(t instanceof m&&("mat2"===r.glsltype||"mat3"===r.glsltype||"mat4"===r.glsltype))return t.toInstanceArray(r.instance,r.size);if(t instanceof U&&("vec2"===r.glsltype||"vec3"===r.glsltype||"vec4"===r.glsltype||"ivec2"===r.glsltype||"ivec3"===r.glsltype||"ivec4"===r.glsltype||"bvec2"===r.glsltype||"bvec3"===r.glsltype||"bvec4"===r.glsltype))return t.toInstanceArray(r.instance,r.size);if(("number"==typeof t||t instanceof Number)&&("int"===r.glsltype||"float"===r.glsltype||"bool"===r.glsltype))return new r.instance([t]);throw console.log(t),"not toArraydata"}if(r.is_array)for(var a=0;a<e.length;a++)-1!==r.location[a]&&null!==e[a]&&(e[a]=o(e[a]));else e=o(e);if("attribute"===r.modifiers)i.bindBuffer(i.ARRAY_BUFFER,e),this.enable_vertex_number[r.location[0]]||(i.enableVertexAttribArray(r.location[0]),this.enable_vertex_number[r.location[0]]=!0),i.vertexAttribPointer(r.location[0],r.size,"FLOAT"===r.btype?i.FLOAT:i.SHORT,!1,0,0);else if(r.is_array)for(var h=0;h<e.length;h++)-1!==r.location[h]&&null!==e[h]&&r.bind(r.location[h],e[h]);else r.bind(r.location[0],e);return!0},f.prototype.bindMesh=function(t){if(!this.isLinked())return 0;var e=this.sys.getGL();if(null===e)return 0;var i=t.getGLData();if(null===i)return 0;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.ibo.data);var n=i.ibo.array_length;for(var r in this.variable)"uniform"!==this.variable[r].modifiers&&void 0!==i.vbo[r]&&this.bindData(r,i.vbo[r].data);return n};function d(t){this.index=t.index,this.materialIndex=t.materialIndex,this.uv=t.uv,this._isEnabledTexture=null!==t.uv[0],this.face={},this.vertex={},this.face.normal=null,this.face.tangent=null,this.face.binormal=null,this.vertex.normal=[null,null,null],this.vertex.tangent=[null,null,null],this.vertex.binormal=[null,null,null]}var g=function(i){function t(){i.call(this)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.clone=function(){return i.prototype.clone.call(this,t)},t.prototype.getGLHash=function(){return""+this.mode+this.power+this.range+this.position.toString(3)+this.direction.toString(3)+this.color.toString(3)},t.prototype.getGLData=function(){var t=this.color.mul(this.power),e=new U;return this.mode===i.MODE.DIRECTIONAL_LIGHT?e=this.direction:this.mode===i.MODE.POINT_LIGHT&&(e=this.position),{lightsData1:new p([this.mode,this.range,e.x,e.y],4,p.datatype.Float32Array),lightsData2:new p([e.z,t.x,t.y,t.z],4,p.datatype.Float32Array)}},t}(n),y=function(i){function t(t,e){i.call(this,t,e)}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.getGLHash=function(){return this.name},t.prototype.getGLData=function(){var t=this.textureColor.getGLData(),e=this.textureNormal.getGLData(),i=[null===t?0:1,null===e?0:1];return t=null===t?this.sys._getDummyTexture():t,e=null===e?this.sys._getDummyTexture():e,{materialsColorAndDiffuse:new p([this.color.x,this.color.y,this.color.z,this.diffuse],4,p.datatype.Float32Array),materialsSpecularAndPower:new p([this.specular.x,this.specular.y,this.specular.z,this.power],4,p.datatype.Float32Array),materialsEmission:new p(this.emission,3,p.datatype.Float32Array),materialsAmbientAndReflect:new p([this.ambient.x,this.ambient.y,this.ambient.z,this.reflect],4,p.datatype.Float32Array),materialsTextureExist:new p(i,2,p.datatype.Float32Array),materialsTextureColor:t,materialsTextureNormal:e}},t}(r),v=function(i){function t(t,e){i.call(this,t,e),this.gldata=null}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype._init=function(){i.prototype._init.call(this),this.gldata=null},t.prototype.dispose=function(){this.is_dispose||(this.is_dispose=!0,null!==this.gldata&&(this.sys._disposeObject(this),this.gldata=null))},t.prototype.getGLData=function(){return this.is_dispose?null:null!==this.gldata?this.gldata:this.is_loadimage?(this.gldata=this.sys.glfunc.createTexture(this.url,this.image),this.gldata):null},t}(u),_=function(e){function t(t){e.call(this,t)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype._init=function(){e.prototype._init.call(this),this.gldata={},this.is_compile_gl=!1},t.prototype.clone=function(){return e.prototype.clone.call(this,t)},t.prototype.isCompileGL=function(){return this.is_compile_gl},t.prototype.setCompileGL=function(t){this.is_compile_gl=t},t.prototype.createTriangleIndexData=function(){for(var t=this.getVertexArray(),e=this.getTriangleIndexArray(),i=[],n={normal:null,tangent:null,binormal:null},r=0;r<e.length;r++){var s=e[r],o=s.index,a=s.uv;i[r]=s.createGLTriangleIndexData();var h=i[r],m=null;for(var l in m=this.sys.dimensionmode===B.DIMENSION_MODE.RIGHT_HAND?U.getNormalVector(t[o[0]].position,t[o[1]].position,t[o[2]].position,a[0],a[1],a[2]):U.getNormalVector(t[o[2]].position,t[o[1]].position,t[o[0]].position,a[2],a[1],a[0]),n)h.face[l]=m[l]}for(var u=[],c=[],p=0;p<e.length;p++){var f=e[p],d=f.materialIndex,g=i[p];void 0===u[d]&&(u[d]=[],c[d]=[]);for(var y=u[d],v=c[d],_=0;_<3;_++){var x=f.index[_];void 0===y[x]&&(y[x]={normal:new U(0,0,0),tangent:new U(0,0,0),binormal:new U(0,0,0)},v[x]={normal:[],tangent:[],binormal:[]});var E=y[x],T=v[x];for(var w in n)if(null!==g.face[w]){var M=g.face[w].toHash(3);if(T[w][M])continue;E[w]=E[w].add(g.face[w]),T[w][M]=!0}}}for(var D in u){var I=u[D];for(var A in I){var b=I[A];for(var L in n)1e-6<b[L].normFast()&&(b[L]=b[L].normalize())}}var N={};N.normal=Math.cos(50/360*(2*Math.PI)),N.tangent=Math.cos(50/360*(2*Math.PI)),N.binormal=Math.cos(50/360*(2*Math.PI));for(var O=0;O<e.length;O++)for(var R=e[O],C=R.materialIndex,S=i[O],F=u[C],P=0;P<3;P++){var z=F[R.index[P]];for(var G in n){var V=void 0;if(S.face[G])V=S.face[G].dot(z[G])<N[G]?S.face:z;else V=z;S.vertex[G][P]=V[G]}}return i},t.prototype._getGLArrayData=function(){for(var t=this.getVertexArray(),e=this.createTriangleIndexData(),i=[],n=0,r=[],s={},o=0;o<e.length;o++){for(var a=e[o],h=[],m=0;m<3;m++){var l=a.getGLHash(m,t),u=i[l];if(h[m]=void 0!==u?u:n,void 0===u){var c=a.getGLData(m,t);for(var p in i[l]=n,c)void 0===s[p]&&(s[p]=[]),s[p].push(c[p]);n++}}r[o]=new Int16Array(h)}var f=0,d={};d.array_length=3*e.length,d.array=new Int16Array(d.array_length);for(var g=f=0;g<e.length;g++)for(var y=0;y<3;y++)d.array[f++]=r[g][y];var v={};for(var _ in s){var x=s[_],E=x[0].dimension,T={};T.name=_,T.dimension=x[0].dimension,T.datatype=x[0].datatype,T.array_length=E*n,T.array=new T.datatype.instance(T.array_length);for(var w=f=0;w<n;w++)for(var M=0;M<E;M++)T.array[f++]=x[w].data[M];v[_]=T}var D={};return D.ibo=d,D.vbo=v,D},t.prototype.disposeGLData=function(){if(this.isCompileGL()){var t=this.getGLData();if(null!==t){if(void 0!==t.ibo&&(void 0!==t.ibo.data&&this.sys.glfunc.deleteBuffer(t.ibo.data),delete t.ibo),void 0!==t.vbo){for(var e in t.vbo)void 0!==t.vbo[e].data&&this.sys.glfunc.deleteBuffer(t.vbo[e].data);delete t.vbo}for(var i=this.getMaterialArray(),n=0;n<i.length;n++){var r=i[n];for(var s in r){var o=r[s];o instanceof v&&o.dispose()}}}delete this.gldata,this.gldata={},this.setCompileGL(!1)}},t.prototype.getGLData=function(){if(this.isCompileGL())return this.gldata;if(!1===this.isComplete())return null;if(!this.sys.isSetGL())return null;var t=this._getGLArrayData();for(var e in t.ibo.data=this.sys.glfunc.createBufferIBO(t.ibo.array),t.vbo)t.vbo[e].data=this.sys.glfunc.createBufferVBO(t.vbo[e].array);return this.gldata=t,this.setCompileGL(!0),this.gldata},t}(s),x=function(t){function e(){t.call(this)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.getUniforms=function(){for(var t={},e=this.getMesh().getMaterialArray(),i=Math.min(e.length,4),n=0;n<i;n++){var r=e[n].getGLData();for(var s in r)t[s]||(t[s]=[]),t[s].push(r[s])}var o=[];return o.uniforms=t,o},e}(t),E=function(t){function e(){t.call(this)}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.getUniforms=function(){var t={};t.eyeWorldDirection=this.getCamera().getDirection();var e=this.getLights(),i=Math.min(e.length,4);t.lightsLength=new p(i,1,p.datatype.Int32Array);for(var n=0;n<i;n++){var r=e[n].getGLData();for(var s in r)t[s]||(t[s]=[]),t[s].push(r[s])}var o=[];return o.uniforms=t,o},e}(e);d.prototype.getGLHash=function(t,e){var i=this._isEnabledTexture?this.uv[t].toString(2)+this.face.binormal.toString(2)+this.face.tangent.toString(2):"";return e[this.index[t]].getGLHash()+this.materialIndex+i+this.vertex.normal[t].toString(3)},d.prototype.getGLData=function(t,e){var i={},n=e[this.index[t]].getGLData();for(var r in n)i[r]=n[r];var s=this._isEnabledTexture?this.uv[t]:new U(0,0);return i.vertexTextureCoord=new p(s,2,p.datatype.Float32Array),i.vertexMaterialFloat=new p(this.materialIndex,1,p.datatype.Float32Array),i.vertexNormal=new p(this.vertex.normal[t],3,p.datatype.Float32Array),i.vertexBinormal=new p(this.vertex.binormal[t],3,p.datatype.Float32Array),i.vertexTangent=new p(this.vertex.tangent[t],3,p.datatype.Float32Array),i};function L(t){this.pathname=t.replace(/\\/g,"/")}var T=function(o){function t(t,e,i,n,r,s){o.call(this,t,e,i,n,r,s)}return o&&(t.__proto__=o),((t.prototype=Object.create(o&&o.prototype)).constructor=t).prototype.clone=function(){return o.prototype.clone.call(this,t)},t.prototype.inverseTriangle=function(){return o.prototype.inverseTriangle.call(this,t)},t.prototype.createGLTriangleIndexData=function(){return new d(this)},t}(o),w=function(e){function t(t){e.call(this,t)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.clone=function(){return e.prototype.clone.call(this,t)},t.prototype.getGLHash=function(){return this.position.toString(3)},t.prototype.getGLData=function(){return{vertexPosition:new p(this.position,3,p.datatype.Float32Array)}},t}(a),M=function(e){function t(){e.call(this),this.program=null,this.gl=null,this.is_set=!1,this.program_list=[],this.program_listId=0;var s=this,o={};this.glfunc={createBufferVBO:function(t){var e=s.getGL();if(null===e)return null;var i=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),i},createBufferIBO:function(t){var e=s.getGL();if(null===e)return null;var i=e.createBuffer();return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i),e.bufferData(e.ELEMENT_ARRAY_BUFFER,t,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),i},deleteBuffer:function(t){var e=s.getGL();null!==e&&e.deleteBuffer(t)},createTexture:function(t,e){if(!(e instanceof ImageData||e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement))throw"createBufferTexture";var i=s.getGL();if(null===i)return null;var n=null;if(!o[t]){n=i.createTexture(),i.bindTexture(i.TEXTURE_2D,n),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.generateMipmap(i.TEXTURE_2D),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);var r={};r.texture=n,r.count=0,o[t]=r}return n=o[t].texture,o[t].count++,n},deleteTexture:function(t){var e=s.getGL();null!==e&&o[t]&&(o[t].count--,0===o[t].count&&(e.deleteBuffer(o[t].texture),delete o[t]))},createProgram:function(t,e){var i=s.getGL();if(null===i)return null;var n=i.createProgram(),r=!1;return i.attachShader(n,t),i.attachShader(n,e),i.linkProgram(n),i.getProgramParameter(n,i.LINK_STATUS)||(console.log("link error "+i.getProgramInfoLog(n)),i.detachShader(n,t),i.detachShader(n,e),i.deleteProgram(n),r=!(n=null)),{program:n,is_error:r}},deleteProgram:function(t,e,i){var n=s.getGL();if(null===n)return null;n.detachShader(t,e),n.detachShader(t,i),n.deleteProgram(t)},createShader:function(t,e){var i=s.getGL();if(null===i)return null;var n=i.createShader(t),r=!1;return i.shaderSource(n,e),i.compileShader(n),i.getShaderParameter(n,i.COMPILE_STATUS)||(console.log("compile error "+i.getShaderInfoLog(n)),i.deleteShader(n),r=!(n=null)),{shader:n,is_error:r}},deleteShader:function(t){var e=s.getGL();if(null===e)return null;e.deleteShader(t)}}}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.getGL=function(){return this.gl},t.prototype.isSetGL=function(){return null!==this.gl},t.prototype.setCanvas=function(t){var e=t.getContext("webgl")||t.getContext("experimental-webgl");this.canvas=t,this.gl=e},t.prototype.createProgram=function(){var t=new f(this,this.program_listId);return this.program_list[this.program_listId]=t,this.program_listId++,t},t.prototype.disposeProgram=function(){for(var t in this.program_list)this.program_list[t].dispose(),delete this.program_list[t]},t.prototype.setProgram=function(t){if(null===t)return!1;if(!(t instanceof f))throw"not S3GLProgram";return null===this.program&&(this.program=t),null!==t.getProgram()&&(!(this.program!==t||!this.is_set)||(null!==this.program&&this.program.disuseProgram(),this.program=t,this.program.useProgram(),void(this.is_set=!0)))},t.prototype.clear=function(){if(null===this.gl)return!1;var t=this.getBackgroundColor();return this.gl.clearColor(t.x,t.y,t.z,t.w),this.gl.clearDepth(1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),!0},t.prototype.drawElements=function(t){this.is_set&&(this.gl.drawElements(this.gl.TRIANGLES,t,this.gl.UNSIGNED_SHORT,0),this.gl.flush())},t.prototype.deleteBuffer=function(t){if(null===this.gl)return null;this.gl.deleteBuffer(t)},t.prototype._getDummyTexture=function(){if(void 0===this._textureDummyData){var t=document.createElement("canvas");t.width=1,t.height=1;var e=t.getContext("2d").getImageData(0,0,t.width,t.height);this._textureDummyId=this._createID(),this._textureDummyData=this.glfunc.createTexture(this._textureDummyId,e)}return this._textureDummyData},t.prototype._setDepthMode=function(){if(null===this.gl)return null;var t=this.gl;t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL)},t.prototype._setCullMode=function(){if(null===this.gl)return null;var t=this.gl;this.cullmode!==e.CULL_MODE.NONE?(t.enable(t.CULL_FACE),this.frontface===e.FRONT_FACE.CLOCKWISE?t.frontFace(t.CW):t.frontFace(t.CCW),this.cullmode===e.CULL_MODE.FRONT_AND_BACK?t.cullFace(t.FRONT_AND_BACK):this.cullmode===e.CULL_MODE.BACK?t.cullFace(t.BACK):this.cullmode===e.CULL_MODE.FRONT&&t.cullFace(t.FRONT)):t.disable(t.CULL_FACE)},t.prototype._bindStart=function(){this.program.resetActiveTextureId()},t.prototype._bindEnd=function(){},t.prototype._bind=function(t,e){if(this.is_set){var i=this.program,n=0;if(2===arguments.length&&("string"==typeof t||t instanceof String))i.bindData(t,e);else if(1===arguments.length&&t instanceof x){var r=t.getMesh();r instanceof _&&(n=i.bindMesh(r))}else if(1===arguments.length&&t.uniforms){var s=t.uniforms;for(var o in s)i.bindData(o,s[o])}return n}},t.prototype.drawScene=function(t){if(this.setProgram(this.program),this.is_set){this._setDepthMode(),this._setCullMode(),this._bindStart(),this._bind(t.getUniforms());for(var e=t.getCamera().getVPSMatrix(this.canvas),i=t.getModels(),n=0;n<i.length;n++){var r=i[n];if(!1!==r.getMesh().isComplete()){this._bind(r.getUniforms());var s=this.getMatrixWorldTransform(r),o=this.mulMatrix(s,e.LookAt),a=this.mulMatrix(o,e.PerspectiveFov);this._bind("matrixWorldToLocal4",s.inverse4()),this._bind("matrixLocalToWorld4",s),this._bind("matrixLocalToWorld3",s),this._bind("matrixLocalToPerspective4",a);var h=this._bind(r);h&&this.drawElements(h)}}this._bindEnd()}},t.prototype._disposeObject=function(t){t instanceof v&&this.glfunc.deleteTexture(this.url)},t.prototype.createVertex=function(t){return new w(t)},t.prototype.createTriangleIndex=function(t,e,i,n,r,s){return new T(t,e,i,n,r,s)},t.prototype.createTexture=function(t){return new v(this,t)},t.prototype.createScene=function(){return new E},t.prototype.createModel=function(){return new x},t.prototype.createMesh=function(){return new _(this)},t.prototype.createMaterial=function(t){return new y(this,t)},t.prototype.createLight=function(){return new g},t.prototype.createCamera=function(){return new i(this)},t}(B),D={name:"s3default",color:new U(1,1,1,1),diffuse:.8,emission:new U(0,0,0),specular:new U(0,0,0),power:5,ambient:new U(.6,.6,.6),reflect:0,textureColor:null,textureNormal:null},I="JSON",A=function(t,e,i){var n;n="string"==typeof i||i instanceof String?JSON.parse(i):i;var r=0;for(var s in n.Indexes){e.addMaterial(t.createMaterial(s));for(var o=n.Indexes[s],a=0;a<o.length;a++)for(var h=o[a],m=0;m<h.length-2;m++){var l=m%2==0?t.createTriangleIndex(m,m+1,m+2,h,r):t.createTriangleIndex(m-1,m+1,m+2,h,r);e.addTriangleIndex(l)}r++}for(var u=0;u<n.Vertices.length;u++){var c=new U(n.Vertices[u][0],n.Vertices[u][1],n.Vertices[u][2]),p=t.createVertex(c);e.addVertex(p)}return!0},b=function(t){for(var e=t.getVertexArray(),i=t.getTriangleIndexArray(),n=t.getMaterialArray(),r=[],s=0!==n.length?n.length:1,o=D,a=0;a<s;a++)r[a]={material:n[a]?n[a]:o,list:[]};for(var h=0;h<i.length;h++){var m=i[h];r[m.materialIndex].list.push(m.index)}var l=[];l.push("{"),l.push("\tIndexes:{");for(var u=0;u<r.length;u++){var c=r[u];l.push("\t\t"+c.material.name+":[");for(var p=0;p<c.list.length;p++){var f=c.list[p];l.push("\t\t\t["+f[0]+" "+f[1]+" "+f[2]+"]"+(p===c.list.length-1?"":","))}l.push("\t\t]"+(u===r.length-1?"":","))}l.push("\t},"),l.push("\tVertices:[");for(var d=0;d<e.length;d++){var g=e[d].position;l.push("\t\t["+g.x+" "+g.y+" "+g.z+"]"+(g===e.length-1?"":","))}return l.push("\t]"),l.push("}"),l.join("\n")};L.prototype.getAbsolutePath=function(){if(/$http/.test(this.pathname))return this.pathname;var t=window.location.toString();/\/$/.test(t)||(t=t.match(/.*\//)[0]);for(var e=this.pathname.split("/"),i=0;i<e.length;i++)""!==e[i]&&"."!==e[i]&&(".."!==e[i]?(t+=e[i],i!==e.length-1&&(t+="/")):t=t.substring(0,t.length-1).match(/.*\//)[0]);return t},L.prototype.getParent=function(){var t=this.getAbsolutePath().match(/.*\//)[0];return t.substring(0,t.length-1)};var N="MQO",O=function(t,e,i,n){var r="./";n&&(r=new L(n).getParent()+"/");for(var s=i.split("\n"),o=[],a="none",h=function(t){for(var e=t.split(" "),i=[],n=0;n<e.length;n++)i[n]=parseFloat(e[n]);return i},m=function(t,e){var i=t.split(" "+e+"(");return 1===i.length?[]:i[1].split(")")[0]},l=function(t,e){var i=m(t,e);return 0===i.length?[]:h(i)},u=function(t,e){var i=m(t,e);if(0===i.length)return null;var n=i.split('"');return 3!==n.length?null:n[1]},c=0;c<s.length;c++){var p=s[c].replace(/^\s+|\s+$/g,""),f=p.split(" ")[0];if(-1===p.indexOf("{"))if(-1===p.indexOf("}")){if("Thumbnail"!==a&&"none"!==a)if("Material"===a){var d=f.replace(/"/g,""),g=t.createMaterial();g.setName(d);var y=void 0;0!==(y=l(p,"col")).length&&g.setColor(new U(y[0],y[1],y[2],y[3])),0!==(y=l(p,"dif")).length&&g.setDiffuse(y[0]),0!==(y=l(p,"amb")).length&&g.setAmbient(new U(y[0],y[0],y[0])),0!==(y=l(p,"amb_col")).length&&g.setAmbient(new U(y[0],y[1],y[2])),0!==(y=l(p,"emi")).length&&g.setEmission(new U(y[0],y[0],y[0])),0!==(y=l(p,"emi_col")).length&&g.setEmission(new U(y[0],y[1],y[2])),0!==(y=l(p,"spc")).length&&g.setSpecular(new U(y[0],y[0],y[0])),0!==(y=l(p,"spc_col")).length&&g.setSpecular(new U(y[0],y[1],y[2])),0!==(y=l(p,"power")).length&&g.setPower(y[0]),0!==(y=l(p,"reflect")).length&&g.setReflect(y[0]),(y=u(p,"tex"))&&g.setTextureColor(r+y),(y=u(p,"bump"))&&g.setTextureNormal(r+y),e.addMaterial(g)}else if("vertex"===a){var v=h(p),_=new U(v[0],v[1],v[2]),x=t.createVertex(_);e.addVertex(x)}else if("face"===a){var E=parseInt(f),T=l(p,"V"),w=l(p,"UV"),M=[],D=l(p,"M");if(D=0===D.length?0:D[0],0!==w.length)for(var I=0;I<E;I++)M[I]=new U(w[2*I],w[2*I+1],0);for(var A=0;A<E-2;A++){var b=A%2==0?t.createTriangleIndex(A,A+1,A+2,T,D,M):t.createTriangleIndex(A-1,A+1,A+2,T,D,M);e.addTriangleIndex(b)}}}else a=o.pop();else o.push(a),a=f}return!0},R=function(t){var e=[],i=t.getVertexArray(),n=t.getTriangleIndexArray(),r=t.getMaterialArray();e.push("Material "+r.length+" {");for(var s=0;s<r.length;s++){var o=r[s];e.push('\t"'+o.name+'" col(1.000 1.000 1.000 1.000) dif(0.800) amb(0.600) emi(0.000) spc(0.000) power(5.00)')}e.push("}"),e.push('Object "obj1" {'),e.push("\tvertex "+i.length+" {");for(var a=0;a<i.length;a++){var h=i[a].position;e.push("\t\t"+h.x+" "+h.y+" "+h.z)}e.push("}"),e.push("\tface "+n.length+" {");for(var m=0;m<n.length;m++){var l=n[m],u="\t\t3";u+=" V("+l.index[0]+" "+l.index[1]+" "+l.index[2]+")",u+=" M("+l.materialIndex+")",void 0!==l.uv&&null!==l.uv[0]&&(u+=" UV("+l.uv[0]+" "+l.uv[1]+" "+l.uv[2]+")"),e.push(u)}return e.push("\t}"),e.push("}"),e.join("\n")},C="OBJ",S=function(t,e,i,n){for(var r=i.split("\n"),s=[],o=[],a=0;a<r.length;a++){var h=r[a].split("#")[0].replace(/^\s+|\s+$/g,"");if(0!==h.length){var m=h.split(" ");if("v"===m[0]){var l=new U(parseFloat(m[1]),parseFloat(m[2]),parseFloat(m[3]));s.push(l)}else if("vt"===m[1])new U(parseFloat(m[1]),parseFloat(m[2]),parseFloat(m[3]));else if("vn"===m[2])new U(parseFloat(m[1]),parseFloat(m[2]),parseFloat(m[3]));else if("f"===m[0])for(var u=m.length-3,c=0;c<u;c++){var p=[];p[0]=m[1+c],p[1]=m[1+c+1],p[2]=m[1+c+2];for(var f=[],d=[],g=[],y=0;y<3;y++){var v=p[y].split("/");1===v.length?f[y]=parseInt(v[0],10)-1:2===v.length?(f[y]=parseInt(v[0],10)-1,d[y]=parseInt(v[1],10)-1):3===v.length&&(0!==v[1].length?(f[y]=parseInt(v[0],10)-1,d[y]=parseInt(v[1],10)-1):(f[y]=parseInt(v[0],10)-1,d[y]=null),g[y]=parseInt(v[2],10)-1)}o.push(f)}}}var _=t.createMaterial();e.addMaterial(_);for(var x=0;x<s.length;x++){var E=t.createVertex(s[x]);e.addVertex(E)}for(var T=0;T<o.length;T++){var w=t.createTriangleIndex(0,1,2,o[T],0);e.addTriangleIndex(w)}return!0},F={inputData:function(r,e,i){function n(t,e,i){s._init();var n=F._DATA_INPUT_FUNCTION[e](r,s,t,i);s.setComplete(n)}var s=r.createMesh();if(("string"==typeof e||e instanceof String)&&-1===e.indexOf("\n")){r._download(e,function(t){n(t,i,e)})}else n(e,i,"");return s},outputData:function(t,e){return F._DATA_OUTPUT_FUNCTION[e](t)}};F.TYPE={JSON:I,MQO:N,OBJ:C},F._DATA_INPUT_FUNCTION={},F._DATA_OUTPUT_FUNCTION={},F._DATA_OUTPUT_FUNCTION[I]=b,F._DATA_INPUT_FUNCTION[I]=A,F._DATA_OUTPUT_FUNCTION[N]=R,F._DATA_INPUT_FUNCTION[N]=O,F._DATA_INPUT_FUNCTION[C]=S;function P(t,e){e instanceof U?(this.n=t,this.d=this.n.dot(e)):(this.n=t,this.d=e)}P.prototype.getDistance=function(t){return t.dot(this.n)-this.d},P.prototype.getNearestPoint=function(t){return this.n.mul(-this.getDistance(t)).add(t)},P.prototype.isHitPosition=function(t){return this.getDistance(t)<0},P.prototype.toString=function(){return"Plane("+this.n.toString()+", ["+this.d+"])"};function z(){this._initIDSwitch()}z.prototype._initIDSwitch=function(){this.istyped=!1,this.ispressed=!1,this.isreleased=!1,this.pressed_time=0},z.prototype.clone=function(){var t=new z;return t.istyped=this.istyped,t.ispressed=this.ispressed,t.isreleased=this.isreleased,t.pressed_time=this.pressed_time,t},z.prototype.keyPressed=function(){this.ispressed||(this.istyped=!0),this.ispressed=!0,this.pressed_time++},z.prototype.keyReleased=function(){this.ispressed=!1,this.isreleased=!0,this.pressed_time=0},z.prototype.focusLost=function(){this.keyReleased()},z.prototype.pickInput=function(t){if(!(t instanceof z))throw"IllegalArgumentException";t.ispressed=this.ispressed,t.istyped=this.istyped,t.isreleased=this.isreleased,t.pressed_time=this.pressed_time,this.isreleased=!1,this.istyped=!1};function G(t,e){this._initIDPosition(t,e)}G.prototype._initIDPosition=function(t,e){if(t instanceof G){var i=t;this.set(i)}else void 0===t?(this.x=0,this.y=0):2===arguments.length?this.set(t,e):(this.x=0,this.y=0)},G.prototype.clone=function(){return new G(this)},G.prototype.set=function(t,e){if(t instanceof G){var i=t;this.x=i.x,this.y=i.y}else this.x=t,this.y=e},G.prototype.add=function(t,e){if(t instanceof G){var i=t;this.x+=i.x,this.y+=i.y}else this.x+=t,this.y+=e},G.prototype.sub=function(t,e){if(t instanceof G){var i=t;this.x-=i.x,this.y-=i.y}else this.x-=t,this.y-=e},G.norm=function(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)};function V(t){this._initIDDraggableSwitch(t)}V.prototype._initIDDraggableSwitch=function(t){this.mask=t,this.switch=new z,this.client=new G,this.deltaBase=new G,this.dragged=new G},V.prototype.clone=function(){var t=new V;return t.mask=this.mask,t.switch=this.switch.clone(),t.client=this.client.clone(),t.deltaBase=this.deltaBase.clone(),t.dragged=this.dragged.clone(),t},V.prototype.correctionForDOM=function(t){var e=t.target;return void 0===(e=e||t.currentTarget)?new G(t.clientX,t.clientY):new G(t.clientX/e.clientWidth*e.width,t.clientY/e.clientHeight*e.height)},V.prototype.setPosition=function(t){var e=this.correctionForDOM(t);this.client.set(e),this.deltaBase.set(e),this.dragged._initIDPosition()},V.prototype.mousePressed=function(t){var e=this.correctionForDOM(t);t.button===this.mask&&(this.switch.ispressed||this.dragged._initIDPosition(),this.switch.keyPressed(),this.client.set(e),this.deltaBase.set(e))},V.prototype.mouseReleased=function(t){t.button===this.mask&&this.switch.ispressed&&this.switch.keyReleased()},V.prototype.mouseMoved=function(t){var e=this.correctionForDOM(t);if(this.switch.ispressed){var i=new G(e);i.sub(this.deltaBase),this.dragged.add(i)}this.client.set(e.x,e.y),this.deltaBase.set(e.x,e.y)},V.prototype.focusLost=function(){this.switch.focusLost()},V.prototype.pickInput=function(t){if(!(t instanceof V))throw"IllegalArgumentException";this.switch.pickInput(t.switch),t.client.set(this.client),t.dragged.set(this.dragged),this.dragged._initIDPosition()};function H(){this._initIDMouse()}H.prototype._initIDMouse=function(){this.left=new V(H.MOUSE_EVENTS.BUTTON1_MASK),this.center=new V(H.MOUSE_EVENTS.BUTTON2_MASK),this.right=new V(H.MOUSE_EVENTS.BUTTON3_MASK),this.position=new G,this.wheelrotation=0},H.prototype.clone=function(){var t=new H;return t.left=this.left.clone(),t.center=this.center.clone(),t.right=this.right.clone(),t.position=this.position.clone(),t.wheelrotation=this.wheelrotation,t},H.prototype.mousePressed=function(t){this.left.mousePressed(t),this.center.mousePressed(t),this.right.mousePressed(t)},H.prototype.mouseReleased=function(t){this.left.mouseReleased(t),this.center.mouseReleased(t),this.right.mouseReleased(t)},H.prototype.mouseMoved=function(t){this.left.mouseMoved(t),this.center.mouseMoved(t),this.right.mouseMoved(t),this.position.x=this.left.client.x,this.position.y=this.left.client.y},H.prototype.mouseWheelMoved=function(t){0!==t.wheelDelta&&(this.wheelrotation+=0<t.deltaY?-1:1)},H.prototype.focusLost=function(){this.left.focusLost(),this.center.focusLost(),this.right.focusLost()},H.prototype.pickInput=function(t){if(!(t instanceof H))throw"IllegalArgumentException";this.left.pickInput(t.left),this.center.pickInput(t.center),this.right.pickInput(t.right),t.position.set(this.position),t.wheelrotation=this.wheelrotation,this.wheelrotation=0},H.prototype.setListenerOnElement=function(t){var e=this;t.style.cursor="crosshair",t.style.mozUserSelect="none",t.style.webkitUserSelect="none",t.style.msUserSelect="none",t.style.webkitTouchCallout="none",t.style.webkitTapHighlightColor="rgba(0,0,0,0)",t.addEventListener("mousedown",function(t){e.mousePressed(t)},!1),t.addEventListener("mouseup",function(t){e.mouseReleased(t)},!1),t.addEventListener("mousemove",function(t){e.mouseMoved(t)},!1),t.addEventListener("mouseout",function(){e.focusLost()},!1),t.addEventListener("wheel",function(t){e.mouseWheelMoved(t),t.preventDefault()},!1),t.addEventListener("contextmenu",function(t){t.preventDefault()},!1)},H.MOUSE_EVENTS={BUTTON1_MASK:0,BUTTON2_MASK:1,BUTTON3_MASK:2};function k(){this.mouse=new X.Touch,this.moveDistance=4,this.moveRotate=.5,this.moveTranslateRelative=.1}var Y=function(s){function t(){s.call(this),this._initIDTouch()}return s&&(t.__proto__=s),((t.prototype=Object.create(s&&s.prototype)).constructor=t).prototype._initIDTouch=function(){this.touchcount_to_mask={1:s.MOUSE_EVENTS.BUTTON1_MASK,2:s.MOUSE_EVENTS.BUTTON3_MASK,3:s.MOUSE_EVENTS.BUTTON2_MASK};var e=this;this._mousePressed=function(t){e.mousePressed(t)},this._mouseReleased=function(t){e.mouseReleased(t)},this._mouseMoved=function(t){e.mouseMoved(t)},this.isdoubletouch=!1},t.prototype._initPosition=function(t){this.left.setPosition(t),this.right.setPosition(t),this.center.setPosition(t)},t.prototype._MultiTouchToMouse=function(t){for(var e=0,i=0,n=0;n<t.touches.length;n++)e+=t.touches[n].clientX,i+=t.touches[n].clientY;var r={};if(0<t.touches.length){r.clientX=e/t.touches.length,r.clientY=i/t.touches.length,r.button=this.touchcount_to_mask[t.touches.length];var s=t.touches[0];r.target=s.target?s.target:s.currentTarget}else r.clientX=0,r.clientY=0,r.button=0;return r.touchcount=t.touches.length,r},t.prototype._MoveMultiTouch=function(t){if(2===t.touches.length){var e=t.touches[0],i=t.touches[1];if(!1===this.isdoubletouch)this.isdoubletouch=!0,this.doubleposition=[],this.doubleposition[0]=new G(e.clientX,e.clientY),this.doubleposition[1]=new G(i.clientX,i.clientY);else{var n=new G(e.clientX,e.clientY),r=new G(i.clientX,i.clientY),s=G.norm(this.doubleposition[0],this.doubleposition[1])-G.norm(n,r);this.doubleposition[0]=n,this.doubleposition[1]=r;var o=Math.abs(s)<10?.01*Math.abs(s):.5;this.wheelrotation+=(0<s?-1:1)*o}}else this.isdoubletouch},t.prototype._actFuncMask=function(t,e,i,n){for(var r in s.MOUSE_EVENTS)t.button=s.MOUSE_EVENTS[r],s.MOUSE_EVENTS[r]===n?e(t):i(t)},t.prototype.touchStart=function(t){var e=this._MultiTouchToMouse(t);this._initPosition(e),this._actFuncMask(e,this._mousePressed,this._mouseReleased,e.button)},t.prototype.touchEnd=function(t){var e=this._MultiTouchToMouse(t);this._actFuncMask(e,this._mouseReleased,this._mouseReleased,e.button)},t.prototype.touchMove=function(t){this._MoveMultiTouch(t);var e=this._MultiTouchToMouse(t);this._actFuncMask(e,this._mouseMoved,this._mouseMoved,e.button)},t.prototype.setListenerOnElement=function(t){s.prototype.setListenerOnElement.call(this,t);function e(t){i.touchEnd(t)}var i=this;t.addEventListener("touchstart",function(t){i.touchStart(t)},!1),t.addEventListener("touchend",e,!1),t.addEventListener("touchmove",function(t){i.touchMove(t),t.preventDefault()},!1),t.addEventListener("touchcancel",e,!1)},t}(H),X={DraggableSwitch:V,Mouse:H,Position:G,Switch:z,Touch:Y,Tools:{noScroll:function(){window.addEventListener("load",function(){document.body.style.height="100%",document.body.style.overflow="hidden",document.documentElement.height="100%",document.documentElement.overflow="hidden"},!1)}}};return k.prototype.setCanvas=function(t){this.mouse.setListenerOnElement(t)},k.prototype.setCamera=function(t){this.camera=t.clone()},k.prototype.getCamera=function(){var t=new X.Touch;this.mouse.pickInput(t),this.camera.translateRelative(new U(-t.left.dragged.x*this.moveTranslateRelative,t.left.dragged.y*this.moveTranslateRelative,0)),this.camera.addRotateY(t.right.dragged.x*this.moveRotate),this.camera.addRotateX(-t.right.dragged.y*this.moveRotate);var e=this.camera.getDistance();return e-=t.wheelrotation*this.moveDistance*Math.log(e),this.camera.setDistance(e),this.camera},{System:B,GLSystem:M,Math:l,Angles:h,Vector:U,Matrix:m,Plane:P,SYSTEM_MODE:B.SYSTEM_MODE,DEPTH_MODE:B.DEPTH_MODE,DIMENSION_MODE:B.DIMENSION_MODE,VECTOR_MODE:B.VECTOR_MODE,FRONT_FACE:B.FRONT_FACE,CULL_MODE:B.CULL_MODE,LIGHT_MODE:n.MODE,MESH_TYPE:F.TYPE,MeshLoader:F,CameraController:k}});
